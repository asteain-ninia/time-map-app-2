# 時空地図アプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1 基本情報
- **プロジェクト名**: 時空地図アプリケーション（time-map-app）
- **目的**:
    - 架空世界の歴史を、ユーザーが時間軸に沿って網羅的に視覚化・追跡できるツールを提供する。
    - 対象となる世界の歴史的出来事や勢力の変遷を地図上で管理することで、ユーザーは歴史的な進展や地理的変化をより実際に即した形で管理できる。

- **使用環境**:
    - スタンドアロンのデスクトップアプリケーションとして動作。
    - **プラットフォーム**: Windows, macOS, Linux（Electron.js）。
    - 通信なしでオフライン環境でも利用可能。

### 1.2 システム全体像
- **クライアント**: Electron.jsベースのデスクトップアプリケーション
- **データ保存**: ローカルファイルシステム（JSON形式）
- **ユーザーインターフェース**: 
    - メインマップ表示
    - 編集ツールバー
    - タイムライン（スライダー）
    - プロパティパネル
    - 情報一覧サイドバー

## 2. 機能要件

### 2.1 地図表示機能

- **ベースマップ表示**:
    - SVG形式の地図情報の表示をサポート。
    - 地図の図法は正距円筒図法であることを前提とする。
    - ユーザーが地図の赤道長（km単位）を入力できる。
    - 横方向無限スクロールを実現し、地図の東端・西端をまたぐ領域を表示・編集可能。
    - ズームイン・ズームアウト、パン操作をサポート。
    - 世界地図全体から都市内地図レベルまでの広範囲かつスムーズなズームを実現。
    - ズームレベルは設定にて一定範囲に制限可能。
        - デフォルトのズーム範囲: 最小1倍、最大50倍
        - ユーザーによる設定可能範囲: 最小0.1倍～最大100倍

- **グリッド線と軸の表示:**
    - 地図上に、10度間隔の緯線・経線グリッドを表示する。
    - 赤道、本初子午線、180度経線を強調表示する（色、太さを変える）。
    - グリッド表示のON/OFFを切り替えるボタン。
    - グリッドの間隔を設定可能（5度、10度、15度、30度）。
    - グリッドの色と透明度を設定可能。

- **測量モード**
    - ユーザーが地図画像上で2点クリックすると、その2点間の距離を計算して表示するモード。
    - 正距円筒図法に基づく距離と、大円距離（球面上の最短距離）の両方を計算して表示する。
    - 大円距離に基づく線を描画する。
        - このとき、確実に最短経路を通るようにする。
        - 描画された測量線は一時的なもので、保存されない。
        - 複数の測量線を同時に表示可能。
        - 測量線のクリアボタンを提供。
    - ユーザーが地図画像上をクリックした地点の緯度経度を表示する。
        - 緯度経度は度分秒形式と十進形式の両方で表示。
        - クリックした地点に一時的なマーカーを表示。
    - ユーザーがボタン操作で、地図の表示経度を左右に10度ずつシフトできる。これにより、本初子午線中心の地図と太平洋中心の地図などを切り替えられる。
        - 「経度シフト」スライダーまたは±10度ボタンで操作。
        - 現在の中心経度を表示。

- **地理情報の表示**:
    - 以下の情報を表示可能：
        - **点情報**: 都市、出来事など
            - 位置（単一頂点に紐づく）
            - プロパティ（名前、説明、年代、カテゴリなど）
            - 視覚的表現（アイコン、色、サイズなど）
        - **線情報**: 道路、交易路、鉄道など
            - 複数頂点のパス
            - プロパティ（名前、説明、年代、カテゴリなど）
            - 視覚的表現（線種、色、太さなど）
            - 長さを計算し、表示する（km単位）。
        - **面情報**: 国家、領域（無政府地帯を含む）など
            - 閉じたパス（複数頂点）
            - 任意の数の穴の空いた領域に対応する。
            - プロパティ（名前、説明、年代、カテゴリなど）
            - 視覚的表現（塗りつぶし色、境界線など）
            - 面積を計算し、表示する（km²単位）。
            - 飛び地をサポート：地理的に離れた複数のポリゴンを同一の面情報として扱う。
                - 飛び地は分離して描画し、人工的な線で繋がないようにする。
                - すべてのレベルの面情報（基礎自治体を含む）で飛び地をサポート。

- **穴あき領域の編集**:
    - 面情報に穴（内部に除外される領域）を追加・編集・削除できる。
    - 穴の追加操作：
        - 編集モードで面情報を選択し、「穴追加」ツールを選択。
        - 追加したい穴の形状を複数の頂点で指定（最低3点が必要）。
        - 確定ボタンで穴を追加。
    - 穴の編集操作：
        - 既存の穴の頂点を選択して位置を変更。
        - 穴の輪郭上をクリックして新しい頂点を追加。
        - 穴の頂点を選択して削除キーで削除。
    - 穴の削除操作：
        - 穴を選択し、コンテキストメニューまたは削除キーで削除。
    - 制約：
        - 穴は面情報の内部に完全に含まれる必要がある。
        - 穴同士が交差してはならない。
        - 面情報の境界と穴の境界が交差してはならない。

- **面情報の排他性**:
    - 同じレイヤー内にある面情報と面情報は、決して重ならない。
    - 面編集時、以下の制約を適用：
        - 同じレイヤー内の他の面情報の中に頂点をドラッグすると、エッジによって阻まれる。
        - エッジに沿って「滑る」動作を実装（カーソルがモニター端に達したときの挙動と同様）。
        - 頂点が滑っている境界は視覚的にハイライト表示する（色の変更や太さの増加）。
        - エッジ間の衝突判定も実装し、尖った部分を「飛び越える」ような動きでも重なりが発生しないようにする。
    - 面情報追加時、他の面情報の内部には頂点を設置できない。
    - 線情報と点情報は面情報との干渉を受けない（重なることが可能）。
    - 線情報と点情報に排他性はない。

- **衝突処理の詳細アルゴリズム**:
    - エッジ沿いの滑り処理:
        - 頂点がエッジに接触した時点で、エッジ上への垂直投影点を計算
        - ドラッグ方向とエッジの方向ベクトルの内積を使用して、エッジに沿った移動方向を決定
        - エッジに沿って移動する際、エッジの端（頂点）に到達した場合:
            1. 接続された次のエッジがあり、ドラッグ方向が次のエッジへ進む方向であれば、次のエッジへ自動的に遷移
            2. 袋小路（行き止まり）の場合、それ以上の移動を制限
    - 衝突判定アルゴリズム:
        - 前処理: 空間分割（四分木など）を用いて衝突判定対象を絞り込み
        - 多角形間の交差判定:
            1. 辺同士の交差チェック: すべての辺の組み合わせで交差判定（計算量削減のため空間分割を活用）
            2. 包含チェック: 一方の多角形が他方に完全に含まれるケースの検出
            3. 自己交差チェック: 編集後の多角形が自己交差していないことを確認
        - リアルタイム衝突回避:
            1. 移動先位置で仮想的にポリゴンを再構築
            2. 他ポリゴンとの衝突判定を実行
            3. 衝突が検出された場合、最も近い有効位置（衝突しない位置）を計算し、そこに移動
            4. 有効な移動先がない場合は、移動を抑制

- **共有頂点システム**:
    - 複数の面情報や線情報が同じ頂点を持つことでその境界を連動させる。
    - 共有された頂点の特徴：
        - 視覚的に通常の頂点と区別（異なる色、サイズなど）。
        - ある頂点を画面上の距離で他の頂点に近づけることで共有頂点になる。
            - 近接判定は絶対座標ではなくスクリーン座標で行い、同じ頂点のペアでも共有化されるかどうかはズームレベルに応じて変化する。
            - デフォルトのスナップ距離は20px。
        - 共有頂点をドラッグすると、その頂点を共有するすべての形状が連動して変化。
            - 共有頂点移動時の排他性制約：
              - 共有頂点の移動により同一レイヤー内でポリゴン同士が重なる状況は原則として発生しない（すべての共有ポリゴンが同時移動するため）
              - 異なるレイヤーに属する共有ポリゴン間では重なりが発生する可能性があるが、これは許容される
              - 共有ポリゴン群と非共有ポリゴン間の重なりが発生する場合は、エッジ滑り処理が適用される
        - 共有頂点のコンテキストメニューには「共有解除」オプションがある。
            - 共有解除すると、同じ座標に複数の独立した頂点が存在する状態になる。
        - 移動前の距離が一定以下である二点は、自動的に共有化されない（誤操作防止）。
            - 共有解除直後の頂点間がすぐに共有化されてしまわないための仕様。
            - 一度少し離れた場所に移動してから再度近づけることで共有化サれるようになる。

- **多層レイヤー構造**:
    - 情報は複数階層（レイヤー）で管理できる。
    - レイヤーの特性：
        - レイヤーは序列（階層）を持ち、この順序は固定（入れ替え不可）。
        - 各レイヤーには一意の識別子と名前がある。
        - すべてのオブジェクト（点、線、面）は一つのレイヤーのみに属する（複数レイヤーに属さない）。
        - レイヤーの表示/非表示を個別に切り替え可能。
        - 表示中のレイヤーは、現在フォーカスされていないレイヤーは薄く表示。
    - レイヤー間の関係：
        - 「上位レイヤー」：対象レイヤーより上位の階層にあるレイヤー。
        - 「下位レイヤー」：対象レイヤーより下位の階層にあるレイヤー。
        - 「上位領域」：面情報が属する上位レイヤーの面情報。
        - 「下位領域」：面情報に属する下位レイヤーの面情報。
    - レイヤー間の制約：
        - 面情報は上位レイヤーの1つの面情報に必ず属する（最上位レイヤーの場合を除く）。
        - 下位領域を持つ面情報は、その形状を直接編集できない。
        - 面情報の形状は、下位領域の和として計算される（下位領域がある場合）。
        - 下位領域を持つ面情報は頂点情報（vertexIds）を保持せず、常に下位領域の和として描画される。
        - 下位領域をすべて喪失した場合、上位領域も自動的に消失する。
    - レイヤー表示の操作：
        - 離散的なレイヤースライダーで表示レイヤーを切り替え。
        - 下位レイヤー表示時、そこに面情報がない場合は上位レイヤーの形状を流用。
        - レイヤー設定パネルでの詳細な表示設定が可能。

- **分裂と割譲/合邦機能**:
    - **分裂機能**：
        - 面情報を複数の部分に分割する機能。
        - 分割方法：
            - **二分割**：線を引いて面を2つに分ける。
            - **穴あけ分割**：内部に穴を作り、その部分を新しい面情報とする。
        - 分割条件：
            - 下位領域がない面情報のみ分割可能。
            - 分割後の面情報は最小3頂点以上必要。
        - 分割操作：
            - ナイフツールで分割線を描く（二分割）。
            - ホールツールで穴を作成（穴あけ分割）。
            - 分割後、新しい面情報の属性を設定。
    - **割譲と合邦機能**：
        - 面情報の所属関係を変更する機能。
        - 操作方法：
            - 面情報を選択し、コンテキストメニューから「所属変更」を選択。
            - 新しい上位領域を選択するダイアログを表示。
        - 割譲：下位領域が既存ではない新しい上位領域に属することで、上位領域の分裂を表現。
        - 合邦：下位領域すべてが別の上位領域に属することで、合邦を表現。
        - 飛び地化：下位領域は、陸続きではない上位領域にも属することが可能。
            - この場合、上位領域の形状は自動的に下位領域を含むように更新される。
            - 飛び地は地理的に分離して描画され、人工的な接続線は表示されない。
        - 制約：
            - 自分自身に下位領域がない場合のみ所属変更可能。
            - レイヤー間の移動は自由（レベル5からレベル1への昇格なども可能）。

### 2.2 時間管理機能

- **時間軸スライダー**:
    - スライダー操作による年代切替：
        - スライダーを動かすと即時に表示データが更新される。
        - 数値入力による直接指定も可能。
    - 時間単位：
        - 年・月・日の単位で指定可能。
        - 負の値をサポート。
    - 時間範囲：
        - 最小値と最大値を設定可能（デフォルトは0年～10000年）。
    - 時間軸表示：
        - スライダー下部に目盛りと年代表示。
        - 主要な歴史的イベントがマークとして表示可能。
    - 独自歴機能：
        - 地球とは異なる公転周期・自転周期・月齢に対応した独自歴に対応。
        - 時間軸スライダーは設定された独自歴に従って正しく目盛りとラベルを表示。
        - 各オブジェクトのプロパティに記録される日時情報は、独自歴の単位に基づいて内部的に正規化・管理される。
        - ユーザーが独自歴の設定を変更した場合、すべての時間依存データがリアルタイムに再計算され、表示が更新される。
- **時間依存データの管理**:
    - 各オブジェクト（点、線、面）は時間依存のプロパティを持つ：
        - 属性（名前、説明など）は時間によって変化可能。
        - 各時点での属性は「properties」配列で管理。
        - 配列内の各要素は以下の時間属性を持つ：
            - `year`: 年
            - `month`: 月
            - `day`: 日
            - `startYear`/`startMonth`/`startDay`: 存在開始時点（オプション）
            - `endYear`/`endMonth`/`endDay`: 存在終了時点（オプション）
    - オブジェクトの存在自体も時間依存：
        - 特定の時点でのみ存在するオブジェクトを定義可能。
        - 存在期間はプロパティで定義（startYear/endYear など）。
    - 時間変化の視覚化：
        - スライダーを動かすと、該当時点の状態に即時更新。
    - 時間表現の正規化：
        - 内部的には年月日をすべて日付オブジェクトとして扱う。
        - UI上では年のみ、年月、年月日の各レベルで表示・編集可能。
        - 時間比較や計算はすべて正規化された値で行う。
    - 過去のある一点でオブジェクトのプロパティや存在期間を編集した場合、以下の挙動となる：
        - 編集点より未来のプロパティは、その変更が明示的に終了または上書きされるまで継続的に影響を受ける。
        - 未来の時点で既に明示的に設定されたプロパティは、過去の変更により自動的には書き換えられない（競合する場合はユーザーに警告表示）。
        - オブジェクトの存在終了を過去に設定した場合、その後の未来のプロパティはすべて無効化される（削除はされず、一時的に非アクティブとなる）。再び存在期間を伸ばした場合、元のプロパティが再表示される。
        
### 2.3 オブジェクト編集機能

- **アンドゥ・リドゥ**:
    - すべての編集操作に対応：
        - オブジェクトの追加/削除/修正
        - 頂点の追加/削除/移動
        - 属性の変更
        - レイヤー間の移動や所属変更
    - 操作粒度：
        - 単一の操作（ドラッグ、クリック）単位でアンドゥ可能。
        - 関連する複数の変更をグループ化し単一のアンドゥ単位とすることも可能。
    - 履歴管理：
        - アンドゥスタックとリドゥスタックで履歴を管理。
        - 履歴の深さは最大100操作まで（設定可能）。
    - UI操作：
        - Ctrl+Z (Windows) または Command+Z (Mac) でアンドゥ。
        - Ctrl+Y (Windows) または Command+Shift+Z (Mac) でリドゥ。
        - 編集メニューからも操作可能。

- **追加モード**:
    - モード切替：
        - ツールバーのトグルボタンで「追加モード」をON/OFF。
        - 追加モード有効時は関連ツールが表示される。
    - 追加ツール：
        - **点情報追加ツール**：
            - ツール選択後、地図上のクリックで点を配置。
            - 配置と同時にプロパティ入力フォームが表示される。
            - プロパティ：名前、説明、年代、カテゴリ（都市、戦闘など）。
            - キャンセル時は点が削除される。
        - **線情報追加ツール**：
            - ツール選択後、地図上の連続クリックで頂点を追加。
            - 2点以上で線として成立し、確定ボタンが表示される。
            - 確定後にプロパティ入力フォームが表示される。
            - プロパティ：名前、説明、年代、カテゴリ（道路、鉄道など）。
            - 線は面情報、または他の線情報と干渉せず、自由に配置可能。
        - **面情報追加ツール**：
            - ツール選択後、地図上の連続クリックで頂点を追加。
            - 3点以上で面として成立し、確定ボタンが表示される。
            - 確定後にプロパティ入力フォームが表示される。
            - プロパティ：名前、説明、年代、カテゴリ（国家、領域など）。
            - 同一レイヤー内の他の面情報の中には頂点を設置できない。
    - 追加時の共通機能：
        - 追加中オブジェクトは他のオブジェクトとは別のスタイルで仮表示される。
        - 最後の操作の取り消し（最後に追加した頂点の削除など）。
        - 追加作業のキャンセル。
        - グリッド線へのスナップ機能（オプション）。

- **編集モード**:
    - モード切替：
        - ツールバーのトグルボタンで「編集モード」をON/OFF。
        - 編集モード有効時は関連ツールが表示される。
    - 選択機能：
        - オブジェクトをクリックして選択。
        - 選択されたオブジェクトはハイライト表示（色の変更や輪郭の強調）。
        - 複数選択：Shiftキーを押しながらクリックで追加選択。
        - 範囲選択：マウスドラッグで矩形選択範囲を作成。
    - 編集ツール：
        - **点情報編集ツール**：
            - **属性編集**：点のプロパティを変更。
            - **移動**：点をドラッグして位置を変更。
            - **削除**：点を選択してDeleteキーまたはコンテキストメニューから削除。
        - **線情報編集ツール**：
            - **属性編集**：線のプロパティを変更。
            - **頂点編集**：
                - 頂点の表示：線上の各頂点がハンドルで表示される。
                - 頂点選択：クリックで特定の頂点を選択。
                - 頂点移動：選択した頂点をドラッグして移動。
                - 頂点追加：線分上のエッジハンドルをドラッグして新頂点を追加。
                - 頂点削除：頂点を選択してDeleteキーで削除。
                - 2点未満になった場合、追加モードと同様の操作で補完可能。
        - **面情報編集ツール**：
            - **属性編集**：面のプロパティを変更。
            - **頂点編集**：
                - 頂点の表示：面の各頂点がハンドルで表示される。
                - 頂点選択：クリックで特定の頂点を選択。
                - 頂点移動：選択した頂点をドラッグして移動。
                    - 同一レイヤーの他面情報との衝突判定を実施。
                    - エッジに沿った滑り動作を実装。
                - 頂点追加：エッジハンドルをドラッグして新頂点を追加。
                - 頂点削除：頂点を選択してDeleteキーで削除。
                - 3点未満になった場合、追加モードと同様の操作で補完可能。
    - コンテキストメニュー機能：
        - オブジェクトまたは頂点を右クリックで表示。
        - オブジェクト種類やツール種類によって内容が変化。
        - 共通機能：削除、プロパティ編集。
        - 共有頂点固有機能：共有解除。
        - 面情報固有機能：分割、所属変更。

### 2.4 注釈・説明機能

- **詳細情報の記載**:
    - カテゴリ・タイプ属性：
        - 各オブジェクトは標準カテゴリを持つ。
            - 点情報：都市、集落、戦闘、遺跡、等
            - 線情報：道路、鉄道、河川、交易路、国境、等
            - 面情報：国家、地方、海洋、湖沼、等
        - カスタムカテゴリの追加も可能。
        - カテゴリごとに異なる視覚表現（アイコン、色など）を定義可能。
    - 属性情報：
        - 基本属性：名前、説明、年代。
        - 拡張属性：人口、支配者、重要性、等（カテゴリによって異なる）。
        - カスタム属性の追加も可能。
    - 詳細文書：
        - マークダウン形式での詳細文書を添付可能。
        - 画像の埋め込みをサポート。
        - 文書内のリンク機能（他のオブジェクトへの参照など）。
        - 基本的なフォーマット（太字、斜体、リスト、表など）。

- **情報の表示**:
    - ポップアップウィンドウ：
        - オブジェクトクリック時に表示。
        - 基本情報（名前、年代、カテゴリ）を即時表示。
        - 「詳細表示」ボタンで完全な情報を表示。
        - ドラッグ可能で複数同時表示可能。
    - 詳細パネル：
        - モーダルウィンドウでの表示。
        - すべての属性と詳細文書を表示。
        - 編集機能を統合（編集モード時）。
        - 関連オブジェクトへのリンク表示。

- **ツールチップの表示**:
    - マウスオーバー時の即時表示：
        - オブジェクト上にマウスを置くと表示。
        - 簡易情報（名前と年代）のみ表示。
        - ツールチップの表示遅延。

### 2.5 データ保存・読み込み

- **データ保存**:
    - ファイル形式：
        - JSON形式のテキストファイル。
        - ファイル拡張子は `.json`。
        - 形式バージョン（version）を保存して互換性管理。
    - 保存内容：
        - すべての頂点、点、線、面情報。
        - 各オブジェクトの時間依存プロパティ。
        - レイヤー構造と所属関係。
        - アプリケーション設定（スライダー範囲、世界名など）。
    - 保存操作：
        - メニューまたはショートカット（Ctrl+S）で保存。
        - 「名前を付けて保存」機能も提供。
        - 自動保存機能（設定された間隔で一時ファイルに保存）。

- **データ読み込み**:
    - 読み込み操作：
        - メニューまたはショートカット（Ctrl+O）で読み込み。
        - ドラッグ＆ドロップでのファイル読み込みもサポート。
    - バージョン対応：
        - ファイル内のバージョン情報を確認。
        - 互換性のないバージョンの場合は警告を表示。
        - 可能な場合は自動的に形式を変換。

-　**データ読み込み時の詳細な挙動**:
    - ファイルを読み込んだ時点で、データのバージョン互換性をチェック。
    - 互換性がない場合は以下のオプションを提供：
        - 自動変換（可能な場合）
        - 古いバージョンのデータのバックアップを別途保持
    - データ整合性チェックでは以下を確認し、不整合がある場合はユーザーが選択可能な自動修復オプションを提供：
        - 存在しない頂点を参照している点・線・面情報
        - レイヤーの階層構造の不整合
        - 時間プロパティの矛盾（例：開始日時が終了日時よりも未来に設定されている場合）

- **警告機能**:
    - 未保存変更の警告：
        - 保存されていない変更がある状態で以下の操作を行う際に警告表示：
            - 新しいファイルを読み込む
            - アプリケーションを閉じる
            - 新しいプロジェクトを開始する
        - 警告ダイアログには「保存」「保存せず続行」「キャンセル」の選択肢。
    - データ互換性警告：
        - 互換性のないバージョンのファイルを読み込む際に警告。
        - 可能な場合は変換オプションを提示。
    - データ整合性チェック：
        - 読み込み時にデータの整合性をチェック（不正な参照や欠落した情報など）。
        - 問題がある場合は警告を表示し、修復オプションを提示。

- **回復メカニズム**:
    - 自動バックアップ：
        - 設定可能な間隔で自動バックアップを作成（デフォルトは5分ごと）。
        - バックアップファイルは最大5世代まで保持。
        - バックアップファイルは一意のタイムスタンプを持ち、専用ディレクトリに保存。

### 2.6 UI/UX

- **UI要件**:
    - レイアウト：
        - 左側：ツールバー（モード切替、ツール選択）
        - 中央：メインマップ表示エリア
        - 右側：サイドバー（イベント一覧、レイヤー管理）
        - 下部：時間スライダー、ステータスバー
    - インターフェース要素：
        - ツールバー：アイコンと簡潔なラベルで操作を表示
        - メニューバー：標準的なメニュー構造（ファイル、編集、表示、ツール、ヘルプ）
        - ダイアログ：モーダルウィンドウでの操作確認や設定
        - サイドパネル：折りたたみ可能なパネルで補助情報を表示
    - 操作性：
        - ドラッグ可能なウィンドウとパネル
        - ツールチップによる操作ガイド
        - キーボードショートカットのサポート
        - コンテキストメニューでの操作提供

- **フィルター機能**:
    - オブジェクトフィルター：
        - カテゴリに基づくフィルタリング（表示/非表示）
        - 属性値に基づくフィルタリング（条件指定）
    - レイヤーフィルター：
        - レイヤー単位での表示/非表示切替
        - レイヤーの透明度調整
        - 特定レイヤーのみを強調表示
    - 検索機能：
        - 名前、説明、属性値などに基づく検索
        - 検索結果のハイライト表示
        - 検索結果へのジャンプ機能

- **レスポンシブ設計**:
    - ウィンドウサイズに応じたレイアウト調整
    - 最小ウィンドウサイズの指定（800×600ピクセル）

## 3. 非機能要件

### 3.1 パフォーマンス要件
- **レスポンス時間**:
  - ズーム/パン操作は60FPS以上を維持すること。
  - データロード時間はある程度長くて良い。
  - オブジェクト選択・編集操作の応答時間は100ms以内。
  - 大規模データ（5,000オブジェクト以上）でも操作性を維持。

- **メモリ使用量**:
  - メモリ使用量は最大2GB以内に抑える。
  - 大規模データでの効率的なメモリ管理（必要に応じた動的読み込み）。
  - メモリリークの防止対策を実施。

- **ディスク使用量**:
  - 自動保存ファイルの世代管理（最大5世代）。
  - 保存ファイルの最適化（不要データの削除、圧縮など）。
  - 一時ファイルの適切な管理と削除。

- **パフォーマンス最適化技術**:
  - **空間インデックス**:
    - 四分木（Quadtree）を使用した地理オブジェクトの高速検索
    - R木（R-tree）による効率的な範囲検索
    - 空間ハッシュによる衝突検出の高速化
  - **描画最適化**:
    - 視野外のオブジェクトのクリッピング（表示領域外のオブジェクトを描画しない）
    - レベルオブディテール（LOD）技術の採用:
      - ズームレベルに応じた形状の簡略化
      - 遠距離の小さなオブジェクトの統合表示
      - 複雑な形状の動的簡略化（Douglas-Peucker アルゴリズムなど）
    - 描画のバッチ処理
    - ハードウェアアクセラレーションの活用
  - **データ管理**:
    - 必要に応じたデータの遅延読み込み
    - キャッシュ機構による頻繁にアクセスされるデータの高速化
    - インメモリキャッシュとディスクキャッシュの二層構造
  - **イベント処理**:
    - マウス移動などの高頻度イベントのスロットリング
    - 表示更新のバッチ処理と最適化
    - WebWorker を用いた重い計算処理の分離

### 3.2 セキュリティ要件
- **入力検証**:
  - すべてのユーザー入力のバリデーションと無害化。
  - JSONデータのスキーマ検証。
  - 外部データ形式の検証とサニタイズ。

### 3.3 可用性要件
- **信頼性**:
  - 自動保存機能（設定可能な間隔、デフォルトは5分）。
  - データ破損防止のための安全な保存メカニズム（バックアップ作成）。

- **エラー処理**:
  - すべての例外を適切に捕捉し処理。
  - ユーザーフレンドリーなエラーメッセージ。
  - エラーログの記録と診断情報の提供。

### 3.4 拡張性要件
- **プラグイン機構**:
  - APIとフックポイントの提供。

- **データモデルの拡張性**:
  - 新たなオブジェクトタイプの追加を容易にする設計。
  - カスタム属性の定義と管理。
  - データ形式のバージョン互換性の管理。

### 3.5 ユーザビリティ要件
- **学習容易性**:
  - 直感的なUI配置とフロー。
  - ツールチップとヘルプテキスト。
  - チュートリアルと例示。

- **操作効率**:
  - キーボードショートカット。
  - よく使う操作へのクイックアクセス。
  - ドラッグ＆ドロップ操作のサポート。

## 4. データモデル

### 4.1 基本データ構造

- **Vertex（頂点）**
  ```typescript
  {
    id: string;            // 一意の頂点ID（例: "vx-1234567890"）
    x: number;             // X座標
    y: number;             // Y座標
  }
  ```

- **TimePoint（時間点）**
  ```typescript
  {
    year: number;          // 年（必須）
    month?: number;        // 月（オプション、1-12）
    day?: number;          // 日（オプション、1-31）
  }
  ```

- **TimeRange（時間範囲）**
  ```typescript
  {
    start?: TimePoint;     // 開始時点（省略可）
    end?: TimePoint;       // 終了時点（省略可）
  }
  ```

- **Property（プロパティ）**
  ```typescript
  {
    timePoint: TimePoint;  // 適用開始時点
    timeRange?: TimeRange; // 存在期間（省略可）
    name: string;          // 名称
    description: string;   // 説明
    category?: string;     // カテゴリ（オプション）
    [key: string]: any;    // 拡張可能なカスタム属性
  }
  ```

- **Point（点情報）**
  ```typescript
  {
    id: string;            // 一意のID
    vertexIds: string[];   // 頂点IDの配列（通常は単一要素）
    properties: Property[]; // 時間依存プロパティの配列
    layerId: string;       // 所属レイヤーID
  }
  ```

- **Line（線情報）**
  ```typescript
  {
    id: string;            // 一意のID
    vertexIds: string[];   // 頂点IDの配列（順序付き）
    properties: Property[]; // 時間依存プロパティの配列
    layerId: string;       // 所属レイヤーID
  }
  ```

- **Polygon（面情報）**
  ```typescript
  {
    id: string;            // 一意のID
    // 下位領域を持つ場合、vertexIds は null または空配列
    vertexIds: string[] | null; // 外周頂点IDの配列（順序付き）
    holesVertexIds: string[][]; // 穴の頂点IDの配列の配列
    properties: Property[]; // 時間依存プロパティの配列
    layerId: string;       // 所属レイヤーID
    parentId: string;      // 上位領域ID（最上位の場合は "0"）
    childIds: string[];    // 下位領域IDの配列
    
    // 飛び地管理用
    isMultiPolygon: boolean; // 飛び地を持つ複合ポリゴンかどうか
    subPolygons?: {         // 飛び地の場合、個々のポリゴン情報
      vertexIds: string[];  // それぞれの領域の頂点IDの配列
      holesVertexIds: string[][]; // 各領域の穴情報
    }[];
  }
  ```
- **面情報の補足事項**:
    - ポリゴン（面情報）が飛び地を持つ場合（isMultiPolygonがtrue）、subPolygonsは必須項目。
    - vertexIdsは、下位領域を持つ場合にのみnullまたは空配列で設定。それ以外の場合は必ず外周頂点を指定。
    - 下位領域によってのみ定義されるポリゴンは、vertexIdsに依存せず、常にchildIdsを通じて形状を動的に構築する。

- **Layer（レイヤー）**
  ```typescript
  {
    id: string;            // 一意のID
    name: string;          // レイヤー名
    order: number;         // レイヤー順序（小さいほど下位）
    visible: boolean;      // 表示/非表示状態
    opacity: number;       // 不透明度（0.0～1.0）
    description?: string;  // 説明（省略可）
  }
  ```

### 4.2 保存ファイル形式

```json
{
  "version": "1.0",
  "layers": [
    {"id": "layer1", "name": "基本レイヤー", "order": 0, "visible": true, "opacity": 1.0},
    {"id": "layer2", "name": "国家レイヤー", "order": 1, "visible": true, "opacity": 1.0},
    ...
  ],
  "vertices": [
    {"id": "vx-1", "x": 100, "y": 200},
    {"id": "vx-2", "x": 150, "y": 250},
    ...
  ],
  "points": [
    {
      "id": "point1",
      "vertexIds": ["vx-1"],
      "properties": [
        {
          "timePoint": {"year": 1200},
          "timeRange": {
            "start": {"year": 1200},
            "end": {"year": 1500}
          },
          "name": "都市A",
          "description": "...",
          "category": "city"
        },
        {
          "timePoint": {"year": 1500},
          "name": "大都市A",
          "description": "..."
        }
      ],
      "layerId": "layer1"
    },
    ...
  ],
  "lines": [
    {
      "id": "line1",
      "vertexIds": ["vx-2", "vx-3", "vx-4"],
      "properties": [
        {
          "timePoint": {"year": 1300, "month": 6},
          "name": "交易路X",
          "description": "...",
          "category": "trade_route"
        }
      ],
      "layerId": "layer1"
    },
    ...
  ],
  "polygons": [
    {
      "id": "poly1",
      "vertexIds": ["vx-5", "vx-6", "vx-7", "vx-8"],
      "holesVertexIds": [["vx-9", "vx-10", "vx-11"]],
      "properties": [
        {
          "timePoint": {"year": 1000},
          "name": "王国A",
          "description": "...",
          "category": "kingdom"
        }
      ],
      "layerId": "layer2",
      "parentId": "0",
      "childIds": [],
      "isMultiPolygon": false
    },
    {
      "id": "poly2",
      "vertexIds": null,
      "holesVertexIds": [],
      "properties": [
        {
          "timePoint": {"year": 1200},
          "name": "帝国B",
          "description": "...",
          "category": "empire"
        }
      ],
      "layerId": "layer3",
      "parentId": "0",
      "childIds": ["poly3", "poly4"],
      "isMultiPolygon": false
    },
    {
      "id": "poly5",
      "vertexIds": null,
      "holesVertexIds": [],
      "properties": [
        {
          "timePoint": {"year": 1500},
          "name": "植民地C",
          "description": "本土から離れた飛び地を含む",
          "category": "colony"
        }
      ],
      "layerId": "layer2",
      "parentId": "poly1",
      "childIds": [],
      "isMultiPolygon": true,
      "subPolygons": [
        {
          "vertexIds": ["vx-50", "vx-51", "vx-52", "vx-53"],
          "holesVertexIds": []
        },
        {
          "vertexIds": ["vx-60", "vx-61", "vx-62"],
          "holesVertexIds": []
        }
      ]
    },
    ...
  ],
  "metadata": {
    "sliderMin": 1000,
    "sliderMax": 2000,
    "worldName": "架空世界",
    "worldDescription": "...",
    "settings": {
      "zoomMin": 1,
      "zoomMax": 50,
      "gridInterval": 10,
      "autoSaveInterval": 300
    }
  }
}
```

## 5. システムアーキテクチャ

### 5.1 全体構成

システムは以下の主要コンポーネントで構成されます：

- **ドメイン層**: 核となるビジネスロジックと規則
- **アプリケーション層**: ユーザー操作の処理と状態管理
- **インフラストラクチャ層**: データの永続化とレンダリング
- **プレゼンテーション層**: ユーザーインターフェースと対話

### 5.2 ドメイン層

- **エンティティ**:
  - Vertex: 頂点の基本情報
  - Feature: すべての地理オブジェクトの基底クラス
  - Point/Line/Polygon: 具体的な地理オブジェクト
  - Layer: レイヤー情報
  - TimePoint/TimeRange: 時間情報

- **ドメインサービス**:
  - GeometryService: 幾何学計算（距離、面積、交差など）
  - TimeService: 時間管理と履歴処理
  - LayerService: レイヤー間の関係管理

### 5.3 アプリケーション層

- **コマンド処理**:
  - CommandHandler: ユーザー操作をドメインアクションに変換
  - UndoRedoManager: 操作履歴の管理

- **クエリ処理**:
  - QueryHandler: データ検索と取得を担当
  - FilterService: 表示フィルタリングを管理

- **状態管理**:
  - StateManager: アプリケーション状態の集中管理
  - EventBus: コンポーネント間の通信を仲介

### 5.4 インフラストラクチャ層

- **データ永続化**:
  - Repository: データの保存と取得
  - FileManager: ファイル操作の抽象化

- **レンダリング**:
  - Renderer: SVGベースのレンダリングエンジン
  - ViewportManager: ビューポートの管理（ズーム、パンなど）

- **システムサービス**:
  - Logger: ログ記録
  - ConfigManager: 設定管理

### 5.5 プレゼンテーション層

- **ビュー**:
  - MapView: メインマップ表示
  - TimelineView: 時間軸表示
  - ToolbarView: ツールバー表示

- **コントローラ**:
  - MapController: マップ操作の処理
  - ToolController: 編集ツールの操作処理
  - TimelineController: 時間操作の処理

## 6. 用語集

| 用語 | 定義 |
|------|------|
| 点情報 | 単一地点を表す地理情報オブジェクト（都市、イベント地点など） |
| 線情報 | 複数の頂点で構成される線形地理情報オブジェクト（道路、国境など） |
| 面情報 | 閉じた形状を持つ地理情報オブジェクト（国家、領域など） |
| 頂点 | 地理オブジェクトの形状を定義する点 |
| 共有頂点 | 複数のオブジェクトで共有される頂点 |
| レイヤー | 地理情報を階層的に管理するための層 |
| 上位レイヤー | 対象レイヤーより階層が上のレイヤー |
| 下位レイヤー | 対象レイヤーより階層が下のレイヤー |
| 上位領域 | 対象の面情報が属する上位レイヤーの面情報 |
| 下位領域 | 対象の面情報に属する下位レイヤーの面情報 |
| 時間点 | 特定の時点（年/月/日） |
| 時間範囲 | 開始時点と終了時点で定義される期間 |
| 飛び地 | 地理的に分離した同一の面情報の一部 |
| 穴 | 面情報内部にある除外される領域 |
| 衝突判定 | 複数のポリゴン間の重なりを検出する処理 |
| エッジ滑り | 頂点が他のポリゴンのエッジに当たった際に沿って移動する動作 |
| データ整合性チェック | データの参照整合性、内部矛盾などを検出・修復する処理 |
| 独自歴 | ユーザーが設定した公転・自転周期などに基づく架空の暦法 |